# docker/nginx/default.conf

# Adicione o bloco 'http' se ele não existir
http {
    # IMPORTANTE: O IP 127.0.0.11 é o resolvedor DNS interno do Docker.
    # O 'valid=5s' faz com que o Nginx re-resolva o nome a cada 5 segundos.
    resolver 127.0.0.11 valid=5s;

    # O bloco 'upstream' DEVE estar dentro do bloco 'http' ou antes do bloco 'server'
    upstream php-fpm-backend {
        # O 'resolve' faz com que o Nginx procure ativamente pelo IP do hostname no DNS.
        # 'max_fails=3 fail_timeout=5s' são boas práticas para resiliência.
        server custo-parlamentar-app:9000 resolve max_fails=3 fail_timeout=5s;
    }

    server {
        listen 80;
        server_name localhost;
        root /var/www/html/public;

        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";

        index index.html index.htm index.php;

        charset utf-8;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            fastcgi_pass php-fpm-backend; # Aponta para o bloco upstream definido acima
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include fastcgi_params;
        }

        location ~ /\.(?!well-known).* {
            deny all;
        }
    }
}